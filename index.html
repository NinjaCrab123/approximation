<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leibniz | Approximation 30.0</title>
    <!-- COMPUTER MODERN SERIF (TRUE LATEX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@createnextapp/cmu-serif@1.0.1/cmu-serif.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --bg: #000000; --card: #0a0a0a; --border: #1a1a1a; --accent: #fdfceb;
            --text: #ffffff; --dim: #555555; --gold: #d4af37; --fail: #ff4444;
            --pass: #00ff88; --boss: #ff004c;
        }
        * { box-sizing: border-box; }
        
        h1, h2 { font-weight: normal; }
        
        body {
            font-family: "Computer Modern Serif", serif; background-color: var(--bg); color: var(--text);
            margin: 0; display: flex; height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased;
            transition: box-shadow 0.8s ease, filter 0.8s ease;
        }

        /* --- HEAVENLY LIGHT ENGINE --- */
        #heavenly-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 5000; opacity: 0; transition: opacity 1.5s ease;
        }
        .cloud-part {
            position: absolute; top: 0; width: 60vw; height: 100vh;
            background: radial-gradient(circle at center, #111 0%, transparent 70%);
            filter: blur(100px); transition: transform 2s ease-in-out;
        }
        .cloud-left { left: -10vw; transform: translateX(0); }
        .cloud-right { right: -10vw; transform: translateX(0); }
        body.god-mode .cloud-left { transform: translateX(-50vw); }
        body.god-mode .cloud-right { transform: translateX(50vw); }

        .god-ray {
            position: absolute; top: -10%; width: 2px; height: 150vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(253,252,235,0.4) 40%, transparent 100%);
            box-shadow: 0 0 40px rgba(255,255,255,0.5); filter: blur(10px);
            transform-origin: top; animation: raySway 10s infinite alternate ease-in-out;
        }
        @keyframes raySway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }
        
        body.god-mode #heavenly-overlay { opacity: 1; }
        body.god-mode { filter: brightness(1.4) contrast(1.1); box-shadow: inset 0 0 500px rgba(255,255,255,0.3); }

        /* --- ANIMATIONS --- */
        @keyframes violentShake { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(15px,-15px); } 40% { transform: translate(-15px,15px); } 60% { transform: translate(15px,15px); } }
        body.shaking { animation: violentShake 0.08s infinite; }

        /* CHRISTOPHER TRAN MODE - Blurry Sway */
        body.christopher-mode {
            animation: gentleSway 3s ease-in-out infinite;
            filter: blur(1.5px);
        }
        @keyframes gentleSway {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-10px) rotate(-0.5deg); }
            50% { transform: translateX(10px) rotate(0.5deg); }
            75% { transform: translateX(-10px) rotate(-0.5deg); }
        }
        body.christopher-mode * {
            filter: blur(0.3px);
        }

        /* SHENGTONG ZHANG MODE - Holy Glow */
        body.shengtong-mode {
            animation: holyPulse 2s ease-in-out infinite;
            filter: brightness(1.3) contrast(1.1);
        }
        @keyframes holyPulse {
            0%, 100% { filter: brightness(1.3) contrast(1.1); }
            50% { filter: brightness(1.5) contrast(1.2); }
        }
        body.shengtong-mode * {
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        body.shengtong-mode::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.15) 0%, transparent 60%);
            pointer-events: none;
            z-index: 1;
            animation: holyGlow 3s ease-in-out infinite;
        }
        @keyframes holyGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        body.boss-battle { animation: bossPulse 1.5s infinite alternate ease-in-out; }
        @keyframes bossPulse { from { box-shadow: inset 0 0 100px rgba(255,0,76,0.4); } to { box-shadow: inset 0 0 500px rgba(255,0,76,0.7); } }

        /* --- SIDEBAR --- */
        .sidebar { width: 75px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 30px; gap: 40px; z-index: 2000; background: black; }
        .nav-icon { width: 32px; height: 32px; cursor: pointer; opacity: 0.2; transition: 0.3s; fill: white; }
        .nav-icon.active { opacity: 1; border-bottom: 2px solid var(--accent); padding-bottom: 8px; }

        .stage { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; padding: 40px; }
        .panel { width: 100%; max-width: 950px; text-align: center; }
        .hidden { display: none !important; }

        /* --- PILL BUTTONS --- */
        .pill-btn { background: var(--accent); color: #000; border: none; padding: 18px 60px; font-family: inherit; font-size: 1.4rem; border-radius: 50px; cursor: pointer; transition: 0.4s; margin-top: 20px;}
        .pill-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(253, 252, 235, 0.2); background: white; }

        .time-pill { background: #080808; border: 1px solid #1a1a1a; color: #333; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-family: inherit; transition: 0.3s; margin: 0 5px; }
        .time-pill.active { border-color: #555; color: var(--text); background: #0a0a0a; }

        /* --- SPIRAL --- */
        .vortex-container { width: 600px; height: 600px; position: relative; display: flex; justify-content: center; align-items: center; margin: 0 auto; }
        .pi-ring { position: absolute; width: 100%; height: 100%; animation: rotateCW 40s linear infinite; opacity: 0.15; }
        .pi-digit { position: absolute; left: 50%; top: 50%; font-size: 1.4rem; color: #fff; }
        @keyframes rotateCW { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- HUD --- */
        .game-hud { display: grid; grid-template-columns: 1fr 1fr 1fr; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 50px; }
        .hud-val { font-size: 2.2rem; }
        #q-wrap { font-size: 5.5rem; min-height: 250px; display: flex; align-items: center; justify-content: center; }
        input { background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--accent); font-size: 3.5rem; text-align: center; width: 450px; outline: none; font-family: inherit; }

        /* --- POPUP --- */
        .pop-text { position: absolute; pointer-events: none; font-size: 3.2rem; font-style: italic; opacity: 0; animation: burstFloat 4.8s cubic-bezier(0.1, 0.5, 0.2, 1) forwards; z-index: 100; font-weight: bold; text-shadow: 0 0 20px rgba(0,255,136,0.3);}
        @keyframes burstFloat { 0% { transform: translate(0, 0) scale(0.4); opacity: 0; } 10% { opacity: 1; transform: translate(var(--tx), var(--ty)) scale(1.1); } 100% { opacity: 0; transform: translate(var(--tx2), var(--ty2)) scale(0.8); } }

        .lb-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left; }
        .lb-table td { padding: 15px 12px; border-bottom: 1px solid #111; }
        .rank-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 3px; background: #553c9a; color: white; margin-left: 10px;}

        /* --- RESULTS --- */
        .chart-frame { position: relative; width: 550px; height: 550px; margin: 20px auto; pointer-events: auto; }
        #drill-down { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(5,5,5,0.98); border: 1px solid var(--accent); padding: 35px; width: 360px; opacity: 0; visibility: hidden; transition: 0.5s; text-align: left; z-index: 1000; pointer-events: none; box-shadow: 0 0 50px black; }
        #drill-down.active { opacity: 1; visibility: visible; pointer-events: auto; }
        #drill-backdrop.active { opacity: 1; visibility: visible; pointer-events: auto; }


        #opponent-reveal, #defeat-banner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.7); z-index: 300; background: #000; padding: 50px; border: 2px solid var(--accent); border-radius: 8px; opacity: 0; transition: 0.5s; box-shadow: 0 0 100px #000; pointer-events: none; }
        #opponent-reveal.show, #defeat-banner.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        #opponent-reveal.boss-detected { border-color: var(--boss); box-shadow: 0 0 40px var(--boss); }
    </style>
</head>
<body id="body-main">

    <div id="heavenly-overlay">
        <div class="cloud-part cloud-left"></div>
        <div class="cloud-part cloud-right"></div>
        <div id="ray-container"></div>
    </div>

    <div id="defeat-banner">
        <h2 style="font-size: 2.8rem; color: var(--accent);">\[ \text{Shengtong has been erased.} \]</h2>
        <p style="color: var(--gold); font-style: italic;">The world is perfectly calibrated.</p>
    </div>

    <nav class="sidebar">
        <svg class="nav-icon active" id="nav-classic" onclick="navTo('classic')" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <svg class="nav-icon" id="nav-intervals" onclick="navTo('intervals')" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
        <svg class="nav-icon" id="nav-ranked" onclick="navTo('ranked')" viewBox="0 0 24 24"><path d="M14.5,14.5L13,16L10,13L11.5,11.5L14.5,14.5M16,13L14.5,11.5L18,8L19.5,9.5L16,13M10.5,10.5L12,12L9,15L7.5,13.5L10.5,10.5M8,9L9.5,10.5L6,14L4.5,12.5L8,9M20.5,3.5L18,6L16.5,4.5L19,2L20.5,3.5M3.5,20.5L6,18L4.5,16.5L2,19L3.5,20.5M21,21L12.5,12.5L21,21M3,3L11.5,11.5L3,3Z"/></svg>
        <svg class="nav-icon" id="nav-leaderboard" onclick="navTo('leaderboard')" viewBox="0 0 24 24"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v3c0 2.55 1.92 4.63 4.39 4.94.99 2.54 3.44 4.06 6.61 4.06 3.17 0 5.62-1.52 6.61-4.06C21.08 14.63 23 12.55 23 10V7c0-1.1-.9-2-2-2z"/></svg>
        <svg class="nav-icon" id="nav-profile" onclick="navTo('profile')" viewBox="0 0 24 24" style="margin-top: auto; margin-bottom: 30px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </nav>

    <main class="stage" id="main-stage">
        
        <div id="view-classic" class="panel">
            <h1 style="font-size: 3.8rem; margin-bottom: 20px;">Numerical Intuition</h1>
            <p style="font-style: italic; color: #444; margin-bottom: 60px; font-size: 1.4rem;">An exercise in continuous approximation.</p>
            <div class="time-select" id="classic-times" style="margin-bottom: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"></div>
            <button class="pill-btn" onclick="startSession('classic')">Begin Analysis</button>
        </div>

        <div id="view-intervals" class="panel hidden">
            <h1 style="font-size: 3.8rem; margin-bottom: 20px;">Market Making</h1>
            <p style="font-style: italic; color: #444; margin-bottom: 60px; font-size: 1.4rem;">Confidence intervals for uncertain quantities.</p>
            <div class="time-select" id="intervals-times" style="margin-bottom: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"></div>
            <button class="pill-btn" onclick="startSession('intervals')">Begin Calibration</button>
        </div>

        <div id="view-intervals-game" class="panel hidden">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 0.9rem; color: var(--dim); margin-bottom: 10px;">SCORE: <span id="interval-score" style="color: var(--accent); font-size: 1.5rem;">0</span> | TIME: <span id="interval-timer" style="color: var(--accent); font-size: 1.5rem;">120</span>s</div>
            </div>
            <div id="interval-question" style="font-size: 1.8rem; line-height: 1.6; margin-bottom: 50px; min-height: 150px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 0 40px;">Loading...</div>
            <div style="display: flex; gap: 20px; justify-content: center; align-items: center; margin-bottom: 30px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--dim); margin-bottom: 10px;">LOWER BOUND</div>
                    <input type="text" id="interval-lower" placeholder="Min" style="width: 200px; font-size: 2rem; text-align: center;" autofocus>
                </div>
                <div style="font-size: 3rem; color: var(--dim);">—</div>
                <div style="text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--dim); margin-bottom: 10px;">UPPER BOUND</div>
                    <input type="text" id="interval-upper" placeholder="Max" style="width: 200px; font-size: 2rem; text-align: center;">
                </div>
            </div>
            <button class="pill-btn" onclick="submitInterval()" style="margin-top: 20px;">Submit Interval</button>
        </div>

        <div id="view-intervals-results" class="panel hidden">
            <h1>Calibration Complete</h1>
            <div style="font-size: 5rem; margin: 30px 0; color: var(--accent);" id="final-interval-score">0</div>
            <div style="font-size: 1.2rem; color: var(--dim); margin-bottom: 20px;">
                Intervals: <span id="intervals-hit" style="color: var(--pass);">0</span> / <span id="intervals-total">0</span>
            </div>
            <div style="font-size: 1.2rem; color: var(--dim); margin-bottom: 40px;">
                Avg Width: <span id="avg-width" style="color: var(--accent);">0</span>
            </div>
            <button class="pill-btn" onclick="navTo('intervals')">Return</button>
        </div>

        <div id="view-ranked" class="panel hidden">
            <h1>Match Mode</h1><p style="font-style: italic; color: #444; font-size: 1.2rem; margin-bottom: 40px;">Competitive synchronization of cognitive speed.</p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <div style="background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 8px; width: 320px;">
                    <div style="font-size: 0.8rem; color: var(--dim);">YOUR RATING</div><div id="ui-elo" style="font-size: 3rem; margin-top: 5px;">1500</div>
                </div>
                <div style="background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 8px; width: 320px;">
                    <div style="font-size: 0.8rem; color: var(--dim);">WORLD RANK</div><div id="ui-world-rank" style="font-size: 3rem; margin-top: 5px;"># --</div>
                </div>
            </div>
            <div id="revive-zone" class="hidden" style="margin-top:20px;"><button class="pill-btn" onclick="reviveShengtong()" style="background:#400; color:white; font-size:1.1rem; padding:12px 30px;">Revive Shengtong (-3000 Elo)</button></div>
            <div class="time-select" id="ranked-times" style="margin-top: 40px; margin-bottom: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"></div>
            <button class="pill-btn" onclick="startSession('ranked')">Find Match</button>
            <div id="history-box" style="margin-top: 20px; text-align: left; background: #050505; border: 1px solid #1a1a1a; padding: 15px; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                <div style="font-size: 0.7rem; color: var(--dim); border-bottom: 1px solid #222; padding-bottom: 5px;">RECENT MATCHES</div><div id="history-list"></div>
            </div>
        </div>

        <div id="view-matchmaking" class="panel hidden">
            <div class="vortex-container" id="vortex-stage">
                <h2 id="matchmaking-status" style="font-size: 3.5rem; font-style: italic; color: var(--accent); position: relative; z-index: 100; transition: opacity 0.5s;">Finding match...</h2>
                <div id="opponent-reveal">
                    <p id="reveal-tag" style="font-size: 0.8rem; letter-spacing: 2px; color: var(--dim); margin-bottom: 15px;">MATCHED WITH</p>
                    <h3 id="opp-name-ui" style="font-size: 2.5rem; margin: 10px 0;">--</h3>
                    <p id="opp-elo-ui" style="color:var(--gold); font-size: 1.2rem; margin-bottom: 20px;">Rating: 1500</p>
                    <div style="display: flex; gap: 30px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #222;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--dim); margin-bottom: 5px;">AVG ACCURACY</div>
                            <div id="opp-acc-ui" style="font-size: 1.5rem; color: var(--accent);">--</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--dim); margin-bottom: 5px;">AVG TIME</div>
                            <div id="opp-time-ui" style="font-size: 1.5rem; color: var(--accent);">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-game" class="panel hidden">
            <div class="game-hud">
                <div class="hud-item"><div>YOU</div><div id="ui-score" class="hud-val">0</div></div>
                <div class="hud-item"><div>TIME</div><div id="ui-timer" class="hud-val">120</div><div id="diff-display" style="font-size:1.2rem; font-weight:bold;">0</div></div>
                <div class="hud-item" id="opponent-hud"><div>OPPONENT</div><div id="ui-opponent-score" class="hud-val">0</div></div>
            </div>
            <div id="q-wrap">\[ \dots \]</div>
            <input type="text" id="ans-input" autofocus autocomplete="off">
        </div>

        <div id="view-leaderboard" class="panel hidden">
            <h1 style="font-size: 3.5rem; margin-bottom: 10px;">Global Leaderboard</h1>
            <table class="lb-table" id="lb-body" style="width:100%"></table>
            <button class="pill-btn" style="margin-top: 30px;" onclick="navTo('classic')">Return</button>
        </div>

        <div id="view-profile" class="panel hidden">
            <h1 style="font-size: 3.5rem; margin-bottom: 10px;">Profile</h1>
            <p style="font-style: italic; color: #444; margin-bottom: 60px; font-size: 1.2rem;">Customize your identity.</p>
            
            <div style="max-width: 500px; margin: 0 auto;">
                <div style="text-align: left; margin-bottom: 30px;">
                    <label style="display: block; font-size: 0.9rem; color: var(--dim); margin-bottom: 10px;">YOUR NAME</label>
                    <input type="text" id="profile-name-input" placeholder="Enter your name..." style="width: 100%; font-size: 1.5rem; padding: 15px; background: var(--card); border: 1px solid var(--border); color: var(--accent); border-radius: 8px;">
                </div>
                
                <button class="pill-btn" onclick="saveName()">Save Name</button>
                
                <div id="name-feedback" style="margin-top: 20px; font-size: 1.1rem; color: var(--accent); min-height: 30px;"></div>
            </div>
            
            <button class="pill-btn" style="margin-top: 60px; background: transparent; border: 1px solid var(--border);" onclick="navTo('classic')">Return</button>
        </div>

        <div id="view-results" class="panel hidden">
            <h1>Analysis Complete</h1>
            <div id="elo-report" class="hidden" style="font-size: 1.8rem; margin: 20px 0;"></div>
            <div class="chart-frame">
                <canvas id="spiderChart"></canvas>
                <div id="drill-backdrop" onclick="document.getElementById('drill-down').classList.remove('active'); this.classList.remove('active')" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 999; opacity: 0; visibility: hidden; transition: 0.3s; pointer-events: none;"></div>
                <div id="drill-down">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;">
                        <div id="drill-name" style="font-size: 1.6rem;">-</div>
                        <button onclick="document.getElementById('drill-down').classList.remove('active'); document.getElementById('drill-backdrop').classList.remove('active')" style="background: none; border: none; color: var(--dim); font-size: 2rem; cursor: pointer; padding: 0; width: 30px; height: 30px; transition: 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--dim)'">×</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">Avg Precision: <span id="d-acc">-</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">Avg Time: <span id="d-latency">-</span></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #222; padding-top: 15px;">Total Points: <span id="d-total">-</span></div>
                </div>
            </div>
            <button class="pill-btn" onclick="location.reload()">Restart</button>
        </div>
    </main>

    <script>
        // ECOSYSTEM
        const BASE_LEGENDS = [
            // Top 6 (ELO 2471-2831)
            { id: "sz", name: "Shengtong Zhang", org: "Stanford University", elo: 2831, isBoss: true },
            { id: "zqs", name: "Zhuo Qun Song", org: "Waterloo", elo: 2513, isBoss: false },
            { id: "ls", name: "Lisa Sauermann", org: "MIT", elo: 2498, isBoss: false },
            { id: "jl", name: "Jeck Lim", org: "Cambridge University", elo: 2487, isBoss: false },
            { id: "tt", name: "Terence Tao", org: "UCLA", elo: 2478, isBoss: false },
            { id: "sr", name: "Srinivasa Ramanujan", org: "Cambridge", elo: 2471, isBoss: false },
            
            // High tier (ELO 2200-2450)
            { id: "yn", name: "Yuan Yao", org: "China", elo: 2380, isBoss: false },
            { id: "rg", name: "Reid Gomez", org: "United States", elo: 2340, isBoss: false },
            { id: "mb", name: "Maryam Mirzakhani", org: "Iran", elo: 2295, isBoss: false },
            { id: "ap", name: "Alex Gunning", org: "United Kingdom", elo: 2250, isBoss: false },
            { id: "lk", name: "Luke Robitaille", org: "Canada", elo: 2210, isBoss: false },
            
            // Mid-high tier (ELO 1900-2200)
            { id: "hs", name: "Hunter Spink", org: "United States", elo: 2150, isBoss: false },
            { id: "jw", name: "James Wills", org: "Australia", elo: 2090, isBoss: false },
            { id: "mk", name: "Matei Mandache", org: "Romania", elo: 2030, isBoss: false },
            { id: "sy", name: "Sherry Yang", org: "United States", elo: 1980, isBoss: false },
            { id: "dc", name: "Daniel Campos", org: "Brazil", elo: 1920, isBoss: false },
            
            // Mid tier (ELO 1600-1900)
            { id: "np", name: "Navneel Singhal", org: "India", elo: 1870, isBoss: false },
            { id: "ek", name: "Emma Koike", org: "Japan", elo: 1820, isBoss: false },
            { id: "tm", name: "Tomas Marques", org: "Portugal", elo: 1770, isBoss: false },
            { id: "kp", name: "Kirill Petrov", org: "Russia", elo: 1720, isBoss: false },
            { id: "an", name: "Anna Nielsen", org: "Denmark", elo: 1670, isBoss: false },
            
            // Lower tier (ELO 1300-1600)
            { id: "jc", name: "Juan Cruz", org: "Argentina", elo: 1620, isBoss: false },
            { id: "mw", name: "Michael Wong", org: "Singapore", elo: 1570, isBoss: false },
            { id: "sp", name: "Sofia Petersen", org: "Norway", elo: 1520, isBoss: false },
            { id: "al", name: "Ahmed Larbi", org: "Morocco", elo: 1470, isBoss: false },
            { id: "vk", name: "Viktor Kovalenko", org: "Ukraine", elo: 1420, isBoss: false },
            { id: "lz", name: "Lin Zhang", org: "China", elo: 1370, isBoss: false },
            { id: "rm", name: "Rosa Martinez", org: "Mexico", elo: 1320, isBoss: false }
        ];

        let legendsPool = JSON.parse(localStorage.getItem('leib_legends')) || BASE_LEGENDS;
        
        // Version check: Reset legends if Shengtong isn't at the top with correct ELO
        const shengtong = legendsPool.find(l => l.id === 'sz');
        if (!shengtong || shengtong.elo !== 2831) {
            legendsPool = [...BASE_LEGENDS];
            localStorage.setItem('leib_legends', JSON.stringify(legendsPool));
        }
        
        let userElo = parseInt(localStorage.getItem('leib_elo')) || 1500;
        let matchHistory = JSON.parse(localStorage.getItem('leib_history')) || [];
        let sessionTime = 120, timeLeft = 120, userScore = 0, oppScore = 0, targetVal = 0, activeCat = "", qStart = 0, currentMode = 'classic', oppInterval, spiderChart = null, totalAttempts = 0, totalAccuracy = 0, currentOpponent = null, godModeInterval = null, isSessionActive = false;

        const catData = { "Div": { name: "Division", history: [] }, "Dec": { name: "Decimals", history: [] }, "Pow": { name: "Exponents", history: [] }, "FrP": { name: "Rational Powers", history: [] }, "Sum": { name: "Addition", history: [] }, "Bin": { name: "Combinations", history: [] } };

        // INTERVAL ESTIMATION QUESTIONS - HARD MODE
        const intervalQuestions = [
            { q: "Number of prime numbers less than 10,000", a: 1229 },
            { q: "Distance from Earth to the Sun (millions of km)", a: 149.6 },
            { q: "Speed of sound in air at 20°C (m/s)", a: 343 },
            { q: "Number of possible unique chess positions after 4 moves", a: 71852 },
            { q: "Gravitational constant G (×10⁻¹¹ N⋅m²/kg²)", a: 6.674 },
            { q: "Half-life of Carbon-14 (years)", a: 5730 },
            { q: "Melting point of tungsten (°C)", a: 3422 },
            { q: "Number of integer partitions of 20", a: 627 },
            { q: "Mass of the electron (×10⁻³¹ kg)", a: 9.109 },
            { q: "Euler's number e to 4 decimal places (as 2.____)", a: 2.7183 },
            { q: "Year Gutenberg invented the printing press", a: 1440 },
            { q: "Number of perfect squares less than 10000", a: 99 },
            { q: "Ratio of circle circumference to diameter (π) to 5 decimals (as 3._____)", a: 3.14159 },
            { q: "Number of vertices on an icosahedron", a: 12 },
            { q: "Planck's constant (×10⁻³⁴ J⋅s)", a: 6.626 },
            { q: "Golden ratio φ to 4 decimals (as 1.____)", a: 1.6180 },
            { q: "Number of ways to arrange 5 distinct objects", a: 120 },
            { q: "Density of gold (g/cm³)", a: 19.3 },
            { q: "Number of edges on a dodecahedron", a: 30 },
            { q: "Boltzmann constant (×10⁻²³ J/K)", a: 1.381 },
            { q: "Year the Battle of Hastings occurred", a: 1066 },
            { q: "Number of zeros in 100! (factorial)", a: 24 },
            { q: "Viscosity of water at 20°C (×10⁻³ Pa⋅s)", a: 1.002 },
            { q: "Number of Platonic solids", a: 5 },
            { q: "Atomic number of uranium", a: 92 },
            { q: "Number of Bell numbers B₅", a: 52 },
            { q: "Specific heat capacity of water (J/g⋅K)", a: 4.184 },
            { q: "Number of Fibonacci numbers less than 1000", a: 16 },
            { q: "Refractive index of diamond", a: 2.417 },
            { q: "Number of Catalan numbers C₅", a: 42 },
            { q: "Standard atmospheric pressure (kPa)", a: 101.325 },
            { q: "Number of derangements of 5 objects", a: 44 },
            { q: "Charge of an electron (×10⁻¹⁹ C)", a: 1.602 },
            { q: "Sum of divisors of 100", a: 217 },
            { q: "Fine structure constant α (×10⁻³)", a: 7.297 }
        ];

        let intervalScore = 0, intervalTimer = 120, intervalData = [], currentQuestion = null, intervalMode = false;

        function getGlobalRank(elo) {
            // Sort user with legends to see if they're in top 10
            const combined = [...legendsPool, {elo: userElo, isUser: true}].sort((a,b) => b.elo - a.elo);
            const userIndexInTop = combined.findIndex(p => p.isUser);
            
            // Only show actual rank (1-10) if user's ELO is truly in top 10
            // Top 10 from normal dist (mean=1500, std=200, 10M pop) is ~2450+ ELO
            if (userIndexInTop < 10 && elo >= 2450) {
                return (userIndexInTop + 1).toString();
            }
            
            // Otherwise use statistical rank (mean=1500, std=200, 10M population)
            const z = (elo - 1500) / 200;
            const probLower = 0.5 * (1 + Math.erf(z / Math.sqrt(2)));
            let rank = Math.floor(10000000 * (1 - probLower));
            return (rank < 1 ? 1 : rank).toLocaleString();
        }

        Math.erf = x => {
            const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
            const p = 0.3275911; const sign = x < 0 ? -1 : 1; x = Math.abs(x);
            const t = 1.0 / (1.0 + p * x);
            return sign * (1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x));
        };

        function resetAll() { 
            document.body.classList.remove('god-mode', 'boss-battle', 'shaking'); 
            document.getElementById('defeat-banner').classList.remove('show'); 
            clearInterval(godModeInterval); 
            clearTimeout(oppInterval); 
        }

        // === PROFILE & NAME EFFECTS ===
        let userName = localStorage.getItem('userName') || '';

        function saveName() {
            const nameInput = document.getElementById('profile-name-input');
            const newName = nameInput.value.trim();
            
            if (newName === '') {
                document.getElementById('name-feedback').innerText = 'Please enter a name';
                return;
            }
            
            userName = newName;
            localStorage.setItem('userName', userName);
            document.getElementById('name-feedback').innerText = '✓ Name saved!';
            
            applyNameEffects();
            
            setTimeout(() => {
                document.getElementById('name-feedback').innerText = '';
            }, 2000);
        }

        function applyNameEffects() {
            // Remove any existing name effects
            document.body.classList.remove('christopher-mode', 'shengtong-mode');
            
            // Apply special effects based on name
            if (userName.toLowerCase() === 'christopher tran') {
                document.body.classList.add('christopher-mode');
            } else if (userName.toLowerCase() === 'shengtong zhang') {
                document.body.classList.add('shengtong-mode');
            }
        }

        function loadProfile() {
            const nameInput = document.getElementById('profile-name-input');
            if (nameInput && userName) {
                nameInput.value = userName;
            }
        }

        // Apply name effects on page load
        applyNameEffects();


        function navTo(id) {
            if (isSessionActive && id !== 'game' && id !== 'intervals-game') {
                if (!confirm("Confirm Forfeit?")) return;
                if (currentMode === 'ranked') { userElo -= 35; localStorage.setItem('leib_elo', userElo); }
                isSessionActive = false;
            }
            resetAll();
            document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
            const view = document.getElementById('view-' + id);
            if (view) view.classList.remove('hidden');
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            
            // Determine which nav icon to activate
            let navIconId = 'classic';
            if (id.includes('intervals')) navIconId = 'intervals';
            else if (id.includes('leaderboard')) navIconId = 'leaderboard';
            else if (id.includes('ranked') || id === 'matchmaking') navIconId = 'ranked';
            else if (id === 'profile') navIconId = 'profile';
            else if (id === 'classic' || id.includes('results')) navIconId = 'classic';
            
            const icon = document.getElementById('nav-' + navIconId);
            if (icon) icon.classList.add('active');
            if(id === 'ranked') updateRankedUI();
            if(id === 'leaderboard') renderLB();
            if(id === 'profile') loadProfile();
        }

        function renderLB() {
            const body = document.getElementById('lb-body');
            const combined = [...legendsPool, { name: "You (Prodigy)", elo: userElo, isUser: true, org: "Global Calibration" }].sort((a,b) => b.elo - a.elo);
            body.innerHTML = `<tr><td style="color:var(--dim)">Rank</td><td>Name</td><td>Rating</td></tr>` +
            combined.slice(0, 10).map((p, i) => `<tr style="background:${p.isUser?'rgba(253,252,235,0.05)':''}"><td>${i+1}</td><td>${p.name} <span style="background:#553c9a; font-size:0.7rem; padding:3px 6px; color:white; border-radius:3px;">MASTER</span><div style="font-size:0.8rem;color:var(--dim)">${p.org}</div></td><td>${p.elo}</td></tr>`).join('');
        }

        function updateRankedUI() {
            document.getElementById('ui-elo').innerText = userElo;
            document.getElementById('ui-world-rank').innerText = "# " + getGlobalRank(userElo);
            document.getElementById('revive-zone').classList.toggle('hidden', legendsPool.some(l => l.id === "sz"));
            document.getElementById('history-list').innerHTML = matchHistory.slice(-5).reverse().map(m => `<div style="display:flex;justify-content:space-between;padding:5px 0;font-size:0.9rem;border-bottom:1px solid #111;"><span>${m.date}</span><span>${m.acc}%</span><span style="color:${m.gain >= 0 ? 'var(--pass)' : 'var(--fail)'}">${m.gain>=0?'+':''}${m.gain} Elo</span></div>`).join('');
        }

        function startSession(mode) {
            currentMode = mode; userScore = 0; oppScore = 0; totalAttempts = 0; totalAccuracy = 0; resetAll();
            Object.values(catData).forEach(c => c.history = []);
            
            if (mode === 'intervals') {
                startIntervalSession();
                return;
            }
            
            if(mode === 'classic') { navTo('game'); initSession(); }
            else { 
                buildVortex(); navTo('matchmaking');
                // Reset matchmaking text
                document.getElementById('matchmaking-status').innerText = 'Finding match...';
                document.getElementById('matchmaking-status').style.opacity = '1';
                document.getElementById('opponent-reveal').classList.remove('show', 'boss-detected');
                
                // Step 1: Show "Finding match..." for 1200ms
                setTimeout(() => {
                    // Step 2: Change to "Match Found!" for 700ms
                    document.getElementById('matchmaking-status').innerText = 'Match Found!';
                    
                    setTimeout(() => {
                        // Step 3: Find opponent and reveal details
                        // Filter to opponents within ±400 ELO, or boss regardless of ELO
                        let viable = legendsPool.filter(l => Math.abs(l.elo - userElo) <= 400 || l.isBoss);
                        
                        // If no viable opponents in range, expand search
                        if (viable.length === 0) {
                            viable = legendsPool;
                        }
                        
                        // Sort by ELO proximity and pick from closest 3 for variety
                        viable.sort((a, b) => Math.abs(a.elo - userElo) - Math.abs(b.elo - userElo));
                        const topCandidates = viable.slice(0, Math.min(3, viable.length));
                        currentOpponent = topCandidates[Math.floor(Math.random() * topCandidates.length)];
                        
                        // Calculate opponent stats based on ELO (matching actual AI)
                        const skill = (currentOpponent.elo - 1500) / 200; // Normalize by std dev
                        const oppAccuracy = currentOpponent.id === "sz" ? 99.9 : Math.min(99, 87 + (skill * 2.4));
                        const oppTime = currentOpponent.id === "sz" ? 0.3 : Math.max(1.2, 6.4 - (skill * 1.0));
                        
                        if (currentOpponent.id === "sz") { 
                            document.body.classList.add('boss-battle', 'shaking'); 
                            document.getElementById('reveal-tag').innerText = '⚠️ BOSS DETECTED';
                            document.getElementById('reveal-tag').style.color = 'var(--boss)';
                            document.getElementById('opponent-reveal').classList.add('boss-detected');
                        } else {
                            document.getElementById('reveal-tag').innerText = 'MATCHED WITH';
                            document.getElementById('reveal-tag').style.color = 'var(--dim)';
                            document.getElementById('opponent-reveal').classList.remove('boss-detected');
                        }
                        document.getElementById('opp-name-ui').innerText = currentOpponent.name;
                        document.getElementById('opp-elo-ui').innerText = "Rating: " + currentOpponent.elo;
                        document.getElementById('opp-acc-ui').innerText = oppAccuracy.toFixed(1) + '%';
                        document.getElementById('opp-time-ui').innerText = oppTime.toFixed(1) + 's';
                        document.getElementById('matchmaking-status').style.opacity = '0';
                        document.getElementById('opponent-reveal').classList.add('show');
                        
                        setTimeout(() => { 
                            document.getElementById('opponent-reveal').classList.remove('show'); 
                            navTo('game'); 
                            initSession(); 
                            startOpponent(); 
                        }, 2500);
                    }, 700);
                }, 1200);
            }
        }

        function triggerGodMode() {
            if (currentOpponent && currentOpponent.id === "sz") {
                document.body.classList.add('shaking');
                setTimeout(() => {
                    document.body.classList.remove('boss-battle', 'shaking'); // Stop shaking when erased
                    document.body.classList.add('god-mode');
                    spawnRays();
                    document.getElementById('defeat-banner').classList.add('show');
                    legendsPool = legendsPool.filter(l => l.id !== "sz"); 
                    localStorage.setItem('leib_legends', JSON.stringify(legendsPool));
                    startGodFountain();
                    
                    // End game shortly after Shengtong is erased
                    setTimeout(() => {
                        isSessionActive = false;
                        clearInterval(godModeInterval);
                        endSession();
                    }, 3000);
                }, 1800);
            } else { 
                document.body.classList.add('god-mode'); 
                spawnRays();
                startGodFountain(); 
            }
        }

        function spawnRays() {
            const container = document.getElementById('ray-container');
            container.innerHTML = "";
            for (let i = 0; i < 20; i++) {
                const ray = document.createElement('div');
                ray.className = 'god-ray';
                ray.style.left = `${Math.random() * 100}%`;
                ray.style.animationDelay = `${Math.random() * 5}s`;
                ray.style.opacity = Math.random() * 0.5;
                container.appendChild(ray);
            }
        }

        function startGodFountain() {
            godModeInterval = setInterval(() => {
                if (!isSessionActive) {
                    clearInterval(godModeInterval); 
                    document.getElementById('ray-container').innerHTML = "";
                    document.getElementById('defeat-banner').classList.remove('show'); 
                    return;
                }
                handleSub(targetVal, 0.05); newQ();
            }, 60);
        }

        function initSession() {
            isSessionActive = true; timeLeft = sessionTime; document.getElementById('ui-timer').innerText = timeLeft; newQ();
            const timer = setInterval(() => {
                if (!isSessionActive) { clearInterval(timer); return; }
                timeLeft--; document.getElementById('ui-timer').innerText = timeLeft;
                if(timeLeft <= 0) { clearInterval(timer); endSession(); }
            }, 1000);
            document.getElementById('ans-input').focus();
        }

        function startOpponent() {
            // Calculate skill based on standard deviations from mean
            const skill = (currentOpponent.elo - 1500) / 200;
            
            // Time between answers (faster at higher ELO) - 20% faster overall
            // ELO 1500 (skill=0): ~6.4s, ELO 2000 (skill=2.5): ~3.9s, ELO 2831 (skill=6.6): ~1.2s
            const mTime = currentOpponent.id === "sz" ? 0.3 : Math.max(1.2, 6.4 - (skill * 1.0));
            
            // Base accuracy increases with ELO - 20% better (reduced error) overall
            // ELO 1500: ~87%, ELO 2000: ~91%, ELO 2500: ~96%, ELO 2831: ~99%
            const baseAccuracy = currentOpponent.id === "sz" ? 0.999 : Math.min(0.99, 0.87 + (skill * 0.024));
            
            function loop() {
                if(!isSessionActive) return;
                oppInterval = setTimeout(() => {
                    // Error rate (lower is more accurate)
                    const errorRate = currentOpponent.id === "sz" ? 0.001 : (1 - baseAccuracy) + (Math.random() - 0.5) * 0.05;
                    
                    // Calculate points based on accuracy
                    let pts = 0;
                    if (errorRate <= 0.1) {
                        pts = 70 + 30 * (1 - errorRate / 0.1);
                    } else if (errorRate <= 1) {
                        pts = 20 + 50 * (1 - (errorRate - 0.1) / 0.9);
                    }
                    
                    // Bonus multiplier for high skill opponents
                    const skillBonus = currentOpponent.id === "sz" ? 1.2 : Math.min(1.1, 0.7 + (skill * 0.06));
                    pts = Math.round(pts * skillBonus);
                    
                    if (pts > 0) { 
                        oppScore += pts; 
                        document.getElementById('ui-opponent-score').innerText = oppScore; 
                        spawnPop(`+${pts}`, currentOpponent.id === "sz" ? "var(--boss)" : "#222", 240, -110); 
                        updateDiff(); 
                    }
                    loop();
                }, mTime * 1000);
            }
            loop();
        }

        function newQ() {
            const keys = Object.keys(catData); activeCat = keys[Math.floor(Math.random() * keys.length)];
            let t = "";
            if (activeCat === "Div") { let a = r(150, 750), b = r(14, 45); t = `${a} \\div ${b}`; targetVal = a/b; }
            else if (activeCat === "Dec") { let d1 = (Math.random()*0.25).toFixed(3), d2 = (Math.random()*0.09+0.01).toFixed(2); t = `${d1} \\div ${d2}`; targetVal = parseFloat(d1)/parseFloat(d2); }
            else if (activeCat === "Pow") { let b = r(8, 25), e = r(2, 4); t = `${b}^{${e}}`; targetVal = Math.pow(b,e); }
            else if (activeCat === "FrP") { let n = r(1, 4), d = r(n+1, 9), e = r(5, 12); t = `\\left(\\frac{${n}}{${d}}\\right)^{${e}}`; targetVal = Math.pow(n/d, e); }
            else if (activeCat === "Sum") { let n1=r(1,15), d1=r(2,16), n2=r(1,15), d2=r(2,16); t=`\\frac{${n1}}{${d1}} + \\frac{${n2}}{${d2}}`; targetVal = (n1/d1)+(n2/d2); }
            else if (activeCat === "Bin") { let n = r(10,20), k = r(2,4); t=`\\binom{${n}}{${k}}`; targetVal = nCr(n,k); }
            const wrap = document.getElementById('q-wrap'); wrap.innerHTML = `\\[ ${t} \\]`; MathJax.typesetPromise([wrap]); document.getElementById('ans-input').value = ""; qStart = Date.now();
        }

        document.getElementById('ans-input').oninput = e => { if (e.target.value.toLowerCase() === "shengtongzhang") { triggerGodMode(); e.target.value = ""; } };
        document.getElementById('ans-input').onkeydown = e => { if(e.key === 'Enter' && e.target.value !== "") { handleSub(parseFloat(e.target.value), (Date.now()-qStart)/1000); newQ(); } };

        function handleSub(val, time) {
            const err = Math.abs(val-targetVal)/targetVal, acc = Math.max(0, (1-err)*100);
            totalAttempts++; totalAccuracy += acc;
            let pts = err <= 0.1 ? 70 + 30 * (1 - err/0.1) : (err <= 1 ? 20 + 50 * (1 - (err-0.1)/0.9) : 0);
            pts = Math.round(pts * (time <= 5 ? (1 - time * 0.01) : (0.95 - (time - 5) * 0.036)));
            if (pts >= 70) spawnPop(`+${pts} Precision`, "var(--pass)", 0, -220); else if (pts > 0) spawnPop(`Ballpark`, "var(--gold)", 0, -220);
            spawnPop(`Acc: ${acc.toFixed(1)}%`, "var(--accent)", -220, -110);
            spawnPop(`Target: ${targetVal.toFixed(2)}`, "#5cb3ff", 220, -110);
            userScore += pts; document.getElementById('ui-score').innerText = userScore;
            catData[activeCat].history.push({pts, time, acc}); updateDiff();
        }

        function endSession() {
            const finalOpp = currentOpponent; isSessionActive = false;
            navTo('results');
            if (currentMode === 'ranked') {
                // Chess-style ELO calculation
                const K = 32; // K-factor
                
                // Calculate expected score (probability of winning)
                const expectedScore = 1 / (1 + Math.pow(10, (finalOpp.elo - userElo) / 400));
                
                // Calculate actual score based on match result
                let actualScore;
                if (userScore > oppScore) {
                    actualScore = 1; // Win
                } else if (userScore === oppScore) {
                    actualScore = 0.5; // Draw
                } else {
                    actualScore = 0; // Loss
                }
                
                // Calculate base ELO change
                let eloChange = K * (actualScore - expectedScore);
                
                // Add bonus/penalty based on score margin (makes wins/losses more impactful)
                const scoreDiff = userScore - oppScore;
                const marginBonus = Math.round(scoreDiff / 15); // ~1 point per 15 score difference
                
                const gain = Math.round(eloChange + marginBonus);
                
                userElo += gain; 
                localStorage.setItem('leib_elo', userElo);
                
                const matchAcc = totalAttempts ? (totalAccuracy/totalAttempts).toFixed(1) : 0;
                matchHistory.push({ date: new Date().toLocaleDateString(), score: userScore, acc: matchAcc, gain });
                localStorage.setItem('leib_history', JSON.stringify(matchHistory));
                
                const rep = document.getElementById('elo-report');
                rep.classList.remove('hidden');
                rep.innerHTML = `Match Result: <span style="color:${gain>=0?'var(--pass)':'var(--fail)'}">${gain>=0?'+':''}${gain} Elo</span>`;
            }
            setTimeout(renderSpider, 100);
        }

        function renderSpider() {
            const ctx = document.getElementById('spiderChart').getContext('2d'); if (spiderChart) spiderChart.destroy();
            const labels = ["Division", "Decimals", "Exponents", "Rational Powers", "Addition", "Combinations"];
            const dataMap = {"Division": "Div", "Decimals": "Dec", "Exponents": "Pow", "Rational Powers": "FrP", "Addition": "Sum", "Combinations": "Bin"};
            const scores = labels.map(l => { const cat = catData[dataMap[l]]; return cat.history.length ? cat.history.reduce((a,b)=>a+b.pts, 0)/cat.history.length : 0; });
            const pColors = scores.map(s => s >= 75 ? '#00ff88' : s >= 50 ? '#fdfceb' : '#ff4444');
            const grad = ctx.createRadialGradient(300, 300, 0, 300, 300, 300); grad.addColorStop(0, 'rgba(253, 252, 235, 0.02)'); grad.addColorStop(1, 'rgba(253, 252, 235, 0.18)');
            spiderChart = new Chart(ctx, {
                type: 'radar', data: { labels, datasets: [{ data: scores, backgroundColor: grad, borderColor: 'rgba(253,252,235,0.3)', borderWidth: 1, pointBackgroundColor: pColors, pointRadius: 10, pointHoverRadius: 20 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, scales: { r: { grid: { color: '#222' }, ticks: { display: false }, pointLabels: { color: '#888', font: { size: 14, family: 'Computer Modern Serif' } }, suggestedMin: 0, suggestedMax: 100 } }, plugins: { legend: { display: false } },
                    onClick: (e) => {
                        const points = spiderChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const idx = points[0].index; const d = catData[dataMap[labels[idx]]];
                            if(d.history.length) {
                                document.getElementById('drill-name').innerText = d.name;
                                document.getElementById('d-acc').innerText = (d.history.reduce((a,b)=>a+b.acc,0)/d.history.length).toFixed(1) + "%"; 
                                document.getElementById('d-latency').innerText = (d.history.reduce((a,b)=>a+b.time,0)/d.history.length).toFixed(2) + "s";
                                document.getElementById('d-total').innerText = d.history.reduce((a,b)=>a+b.pts,0);
                                document.getElementById('drill-down').classList.add('active');
                                document.getElementById('drill-backdrop').classList.add('active');
                            }
                        }
                    }
                }
            });
        }

        // Helpers
        function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function nCr(n, k) { let res = 1; for (let i = 1; i <= k; i++) res = res * (n - i + 1) / i; return res; }
        function updateDiff() { const d = userScore - oppScore; const el = document.getElementById('diff-display'); el.innerText = (d>=0?"+":"")+d; el.style.color = d>=0?"var(--pass)":"var(--fail)"; }
        function spawnPop(text, color, x, y) {
            const el = document.createElement('div'); el.className = 'pop-text'; el.innerText = text; el.style.color = color;
            el.style.setProperty('--tx', `${x}px`); el.style.setProperty('--ty', `${y}px`);
            el.style.setProperty('--tx2', `${x * 1.3}px`); el.style.setProperty('--ty2', `${y - 200}px`);
            document.getElementById('main-stage').appendChild(el); setTimeout(() => el.remove(), 4200);
        }
        function reviveShengtong() { userElo -= 3000; legendsPool = [...BASE_LEGENDS]; localStorage.setItem('leib_elo', userElo); localStorage.setItem('leib_legends', JSON.stringify(legendsPool)); updateRankedUI(); }
        
        function buildVortex() {
            const stage = document.getElementById('vortex-stage'); stage.querySelectorAll('.pi-ring').forEach(r => r.remove());
            const pi = "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679";
            const ring = document.createElement('div'); ring.className = 'pi-ring';
            for (let i = 0; i < 60; i++) {
                const d = document.createElement('span'); d.innerText = pi[i % pi.length]; d.className = 'pi-digit';
                const angle = i * (360 / 60);
                d.style.transform = `translate(${Math.cos(angle*Math.PI/180)*260}px, ${Math.sin(angle*Math.PI/180)*260}px) rotate(${angle+90}deg)`;
                ring.appendChild(d);
            }
            stage.appendChild(ring);
        }

        // === INTERVAL ESTIMATION GAME LOGIC ===
        
        function startIntervalSession() {
            intervalMode = true;
            intervalScore = 0;
            intervalData = [];
            timeLeft = sessionTime;
            isSessionActive = true;
            
            document.getElementById('interval-score').innerText = intervalScore;
            document.getElementById('interval-timer').innerText = timeLeft;
            
            navTo('intervals-game');
            loadNewIntervalQuestion();
            
            const timer = setInterval(() => {
                if (!isSessionActive) { clearInterval(timer); return; }
                timeLeft--;
                document.getElementById('interval-timer').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endIntervalSession();
                }
            }, 1000);
            
            document.getElementById('interval-lower').focus();
        }
        
        function loadNewIntervalQuestion() {
            currentQuestion = intervalQuestions[Math.floor(Math.random() * intervalQuestions.length)];
            document.getElementById('interval-question').innerText = currentQuestion.q;
            document.getElementById('interval-lower').value = '';
            document.getElementById('interval-upper').value = '';
            document.getElementById('interval-lower').focus();
        }
        
        function submitInterval() {
            const lower = parseFloat(document.getElementById('interval-lower').value);
            const upper = parseFloat(document.getElementById('interval-upper').value);
            
            if (isNaN(lower) || isNaN(upper)) {
                alert('Please enter valid numbers for both bounds');
                return;
            }
            
            if (lower >= upper) {
                alert('Lower bound must be less than upper bound');
                return;
            }
            
            const answer = currentQuestion.a;
            const hit = (lower <= answer && answer <= upper);
            const width = upper - lower;
            
            // Scoring: Base 100 points if hit, minus penalty for width
            // Narrower intervals = higher score
            let points = 0;
            if (hit) {
                // Calculate relative width (as % of answer magnitude)
                const relativeWidth = width / Math.abs(answer);
                // Perfect score (100) for very narrow intervals, down to 20 for very wide
                points = Math.max(20, Math.round(100 - (relativeWidth * 50)));
            }
            
            intervalScore += points;
            intervalData.push({ q: currentQuestion.q, lower, upper, answer, hit, width, points });
            
            document.getElementById('interval-score').innerText = intervalScore;
            
            // Visual feedback
            const color = hit ? 'var(--pass)' : 'var(--fail)';
            spawnPop(hit ? `+${points} HIT!` : `MISS`, color, 0, -150);
            spawnPop(`Answer: ${answer}`, 'var(--accent)', 0, -80);
            
            if (isSessionActive) {
                setTimeout(() => loadNewIntervalQuestion(), 800);
            }
        }
        
        function endIntervalSession() {
            isSessionActive = false;
            intervalMode = false;
            
            const hits = intervalData.filter(d => d.hit).length;
            const total = intervalData.length;
            const avgWidth = total > 0 ? (intervalData.reduce((sum, d) => sum + d.width, 0) / total).toFixed(1) : 0;
            
            document.getElementById('final-interval-score').innerText = intervalScore;
            document.getElementById('intervals-hit').innerText = hits;
            document.getElementById('intervals-total').innerText = total;
            document.getElementById('avg-width').innerText = avgWidth;
            
            navTo('intervals-results');
        }
        
        // Add Enter key support for intervals
        document.addEventListener('DOMContentLoaded', () => {
            const lowerInput = document.getElementById('interval-lower');
            const upperInput = document.getElementById('interval-upper');
            
            if (lowerInput) {
                lowerInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('interval-upper').focus();
                    }
                });
            }
            
            if (upperInput) {
                upperInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && intervalMode && isSessionActive) {
                        submitInterval();
                    }
                });
            }
        });

        const times = [10, 30, 60, 120, 300];
        ['classic-times', 'ranked-times', 'intervals-times'].forEach(cid => {
            const el = document.getElementById(cid); el.innerHTML = "";
            times.forEach(t => {
                const b = document.createElement('button'); b.className = `time-pill ${t===120?'active':''}`;
                b.innerText = t < 60 ? `${t}s` : `${t/60}m`;
                b.onclick = e => { sessionTime = t; document.querySelectorAll('.time-pill').forEach(x => x.classList.remove('active')); e.target.classList.add('active'); };
                el.appendChild(b);
            });
        });
        navTo('classic');
    </script>
</body>
</html>